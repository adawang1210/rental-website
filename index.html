<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中央大學租屋地圖</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        .glow-effect {
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
        }
        
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
        }
        
        .animated-bg {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
        }
        
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .pulse-ring {
            animation: pulse-ring 2s infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.95); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        
        .typing-animation::after {
            content: '|';
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .rental-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .rental-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .rental-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .rental-info {
            padding: 20px;
        }
        .rental-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .rental-type {
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            margin-right: 8px;
        }
        .rental-status {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .status-available {
            background: #2ecc71;
            color: white;
        }
        .status-unavailable {
            background: #e74c3c;
            color: white;
        }
        .rental-size-floor {
            color: #666;
            font-size: 0.95em;
            margin: 8px 0;
        }
        .price {
            color: #e74c3c;
            font-size: 1.4em;
            font-weight: bold;
            margin: 10px 0;
        }
        .distance {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .description {
            color: #444;
            font-size: 0.95em;
            line-height: 1.5;
            margin: 12px 0;
        }
        .amenities-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        .amenity-tag {
            background: #f8f9fa;
            color: #666;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .contact-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .contact-info p {
            margin: 5px 0;
            color: #444;
        }
        .view-details {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            margin-top: 10px;
            transition: background 0.2s;
        }
        .view-details:hover {
            background: #2980b9;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
        }
        /* 強制評論彈窗在最上層 */
        #reviewModal {
            z-index: 9999 !important;
        }
        /* Leaflet 地圖容器降低 z-index */
        .leaflet-container {
            z-index: 1 !important;
        }
    </style>
</head>
<body class="min-h-screen animated-bg">
    <!-- 首頁 -->
    <div id="homePage" class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
        <!-- 背景裝飾 -->
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute -top-40 -right-40 w-80 h-80 bg-white opacity-10 rounded-full floating-animation"></div>
            <div class="absolute -bottom-40 -left-40 w-96 h-96 bg-white opacity-5 rounded-full" style="animation-delay: -3s;"></div>
            <div class="absolute top-1/2 left-1/4 w-2 h-2 bg-white opacity-60 rounded-full pulse-ring"></div>
            <div class="absolute bottom-1/4 right-1/3 w-1 h-1 bg-white opacity-40 rounded-full pulse-ring" style="animation-delay: -1s;"></div>
        </div>

        <!-- 主要內容 -->
        <div class="relative z-10 text-center max-w-4xl mx-auto">
            <!-- 標題區域 -->
            <div class="mb-12" data-aos="fade-down" data-aos-duration="1000">
                <div class="inline-flex items-center gap-3 mb-6">
                    <div class="p-3 bg-white bg-opacity-20 rounded-xl backdrop-blur-sm">
                        <i data-lucide="map-pin" class="w-8 h-8 text-white"></i>
                    </div>
                    <h1 class="text-5xl md:text-7xl font-bold text-white mb-4">
                        中央大學
                        <span class="block gradient-text bg-white bg-clip-text">租屋地圖</span>
                    </h1>
                </div>
                <p class="text-xl md:text-2xl text-white opacity-90 mb-4 typing-animation">
                    探索校園周邊最佳住宿選擇
                </p>
                <p class="text-lg text-white opacity-75 max-w-2xl mx-auto">
                    結合地圖導航、真實評價與智能篩選，為中大學生打造最貼心的租屋體驗
                </p>
        </div>

            

            <!-- 地點選擇按鈕 -->
            <div class="space-y-4" data-aos="zoom-in" data-aos-duration="1000" data-aos-delay="400">
                <h2 class="text-2xl font-semibold text-white mb-8">選擇探索區域</h2>
                <div class="grid md:grid-cols-3 gap-4 max-w-4xl mx-auto">
                    <button onclick="selectLocation('ncu')" class="group relative overflow-hidden bg-white bg-opacity-10 backdrop-blur-sm border border-white border-opacity-20 rounded-2xl p-8 card-hover text-left">
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-600 opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                        <div class="relative z-10">
                            <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mb-4 glow-effect">
                                <i data-lucide="graduation-cap" class="w-6 h-6 text-white"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-white mb-2">中央大學後門</h3>
                            <p class="text-white opacity-80 text-sm mb-4">步行3分鐘到校，生活機能完善</p>
                            <div class="flex items-center text-white opacity-60">
                                <i data-lucide="clock" class="w-4 h-4 mr-2"></i>
                                <span class="text-sm">3分鐘步行</span>
                </div>
                    </div>
                    </button>
                    
                    <button onclick="selectLocation('nightMarket')" class="group relative overflow-hidden bg-white bg-opacity-10 backdrop-blur-sm border border-white border-opacity-20 rounded-2xl p-8 card-hover text-left">
                        <div class="absolute inset-0 bg-gradient-to-r from-orange-500 to-red-600 opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                        <div class="relative z-10">
                            <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center mb-4 glow-effect">
                                <i data-lucide="utensils" class="w-6 h-6 text-white"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-white mb-2">宵夜街</h3>
                            <p class="text-white opacity-80 text-sm mb-4">美食天堂，夜生活豐富</p>
                            <div class="flex items-center text-white opacity-60">
                                <i data-lucide="moon" class="w-4 h-4 mr-2"></i>
                                <span class="text-sm">夜市聚集地</span>
                            </div>
                        </div>
                    </button>
                    
                    <button onclick="selectLocation('luxuryAlley')" class="group relative overflow-hidden bg-white bg-opacity-10 backdrop-blur-sm border border-white border-opacity-20 rounded-2xl p-8 card-hover text-left">
                        <div class="absolute inset-0 bg-gradient-to-r from-purple-500 to-pink-600 opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                        <div class="relative z-10">
                            <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mb-4 glow-effect">
                                <i data-lucide="crown" class="w-6 h-6 text-white"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-white mb-2">奢侈巷</h3>
                            <p class="text-white opacity-80 text-sm mb-4">高品質住宿，環境優雅</p>
                            <div class="flex items-center text-white opacity-60">
                                <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                                <span class="text-sm">精品住宿</span>
                            </div>
                        </div>
                    </button>
                            </div>
                        </div>

            <!-- 統計資訊 -->
            <div class="mt-16 grid grid-cols-3 gap-8 max-w-md mx-auto" data-aos="fade-up" data-aos-duration="1000" data-aos-delay="600">
                <div class="text-center">
                    <div class="text-3xl font-bold text-white mb-2">500+</div>
                    <div class="text-white opacity-70 text-sm">房源數量</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-white mb-2">1000+</div>
                    <div class="text-white opacity-70 text-sm">學生評價</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-white mb-2">4.8</div>
                    <div class="text-white opacity-70 text-sm">滿意度</div>
                </div>
            </div>
        </div>
                                </div>

    <!-- 地圖頁面 -->
    <div id="mapPage" class="hidden min-h-screen bg-gray-50">
        <!-- 頂部導航 -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="showPage('homePage')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    返回首頁
                </button>
                <h1 class="text-xl font-semibold text-gray-900">租屋地圖</h1>
                <div class="w-20"></div>
                                </div>
                            </div>

        <!-- 地圖容器 -->
        <div class="flex h-[calc(100vh-64px)]">
            <!-- 地圖區域 -->
            <div class="flex-1 relative">
                <div id="map" class="w-full h-full"></div>
                            </div>
            
            <!-- 租屋列表 -->
            <div class="w-96 bg-white shadow-lg overflow-y-auto">
                <div class="p-6 border-b">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">附近租屋</h2>
                    <!-- 篩選器 -->
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-1 block">價格範圍</label>
                            <select id="priceFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">全部價格</option>
                                <option value="0-8000">8,000以下</option>
                                <option value="8000-12000">8,000-12,000</option>
                                <option value="12000-16000">12,000-16,000</option>
                                <option value="16000+">16,000以上</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-1 block">排序方式</label>
                            <select id="sortFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="price-asc">價格由低到高</option>
                                <option value="price-desc">價格由高到低</option>
                                <option value="rating-desc">評分由高到低</option>
                                <option value="favorites-desc">收藏數由高到低</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-1 block">房屋特色</label>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="hasElevatorFilter" class="mr-2">
                                    <label for="hasElevatorFilter">有電梯</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="hasSeparateBathroomFilter" class="mr-2">
                                    <label for="hasSeparateBathroomFilter">乾濕分離</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="canShortTermFilter" class="mr-2">
                                    <label for="canShortTermFilter">可短租</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="hasParkingFilter" class="mr-2">
                                    <label for="hasParkingFilter">有停車位</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="rentalsList" class="p-4 space-y-4">
                    <!-- 租屋卡片將在這裡動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 詳情頁面 -->
    <div id="detailPage" class="hidden min-h-screen bg-gray-50">
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="showPage('mapPage')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    返回地圖
                </button>
                <h1 class="text-xl font-semibold text-gray-900">租屋詳情</h1>
                <div class="w-20"></div>
            </div>
        </div>
        
        <div class="max-w-4xl mx-auto p-6">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <img id="rentalImage" class="w-full h-80 object-cover" src="" alt="租屋照片">
                        <div id="rentalInfo" class="p-6"></div>
                    </div>
                    <div>
                        <div id="detailMap" class="w-full h-80"></div>
                        <div id="locationInfo" class="p-6"></div>
                    </div>
                </div>
                
                <!-- 評論區 -->
                <div class="border-t p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold">租客評價</h3>
                        <button onclick="showReviewModal(window.currentRentalId)" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            寫評論
                        </button>
            </div>
                    <div id="reviewsList" class="space-y-4">
                        <!-- 評論將在這裡動態生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 評論彈出視窗 -->
    <div id="reviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 relative">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">撰寫評論</h3>
                <button onclick="closeReviewModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="reviewForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">評分</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="reviewRating" min="1" max="5" step="0.5" required
                               class="w-20 px-3 py-2 border border-gray-300 rounded-lg">
                        <span class="text-sm text-gray-500">/ 5</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">評論內容</label>
                    <textarea id="reviewText" rows="4" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeReviewModal()"
                            class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                        取消
                    </button>
                    <button type="submit"
                            class="px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                        提交評論
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

        // 初始化圖標
        lucide.createIcons();
        
        // 初始化AOS動畫
        AOS.init({
            duration: 800,
            once: true
        });

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyCzdE6ZxVrifrzAOP7OV1LsIcJj1QeehGY",
            authDomain: "rental-website-4da8f.firebaseapp.com",
            projectId: "rental-website-4da8f",
            storageBucket: "rental-website-4da8f.firebasestorage.app",
            messagingSenderId: "922669059596",
            appId: "1:922669059596:web:adeac316ceff6d78602829",
            measurementId: "G-Z7L3NFW4YZ",
            databaseURL: "https://rental-website-4da8f-default-rtdb.firebaseio.com"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // 定義地點座標和ID
        const locations = {
            ncu: { 
                id: 0,
                lat: 24.965484, 
                lng: 121.191116, 
                name: '中央大學後門'
            },
            nightMarket: { 
                id: 1,
                lat: 24.965871, 
                lng: 121.193606, 
                name: '宵夜街'
            },
            luxuryAlley: { 
                id: 2,
                lat: 24.966822, 
                lng: 121.192694, 
                name: '奢侈巷'
            }
        };

        // 模擬租屋資料
        const mockRentals = {
            rental1: {
                title: "溫馨套房 - 近中大後門",
                price: 8000,
                type: "套房",
                size: 7.5,
                floor: "2F / 5F",
                areaId: 0, // 後門
                description: "位於中央大學後門附近，走路5分鐘即可到校。房間採光良好，附基本家具（書桌、椅子、床架）。獨立衛浴，適合學生居住。",
                imageUrl: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=400&h=300&fit=crop",
                location: {
                    lat: 24.965684,
                    lng: 121.191316
                },
                amenities: ["冷氣", "冰箱", "Wi-Fi", "洗衣機", "熱水器"],
                available: true,
                contact: {
                    name: "林小姐",
                    phone: "0912-345-678"
                }
            },
            rental2: {
                title: "現代化套房 - 宵夜街",
                price: 9000,
                type: "套房",
                size: 8.0,
                floor: "3F / 5F",
                areaId: 1, // 宵夜街
                description: "位於熱鬧的宵夜街，生活機能極佳。房間全新裝潢，配備齊全。",
                imageUrl: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=400&h=300&fit=crop",
                location: {
                    lat: 24.965971,
                    lng: 121.193506
                },
                amenities: ["冷氣", "冰箱", "Wi-Fi", "洗衣機", "熱水器", "電視"],
                available: true,
                contact: {
                    name: "王先生",
                    phone: "0923-456-789"
                }
            },
            rental3: {
                title: "豪華套房 - 奢侈巷",
                price: 12000,
                type: "套房",
                size: 12.0,
                floor: "4F / 5F",
                areaId: 2, // 奢侈巷
                description: "位於高級住宅區，環境清幽。房間寬敞明亮，配備高級家具及家電。",
                imageUrl: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=400&h=300&fit=crop",
                location: {
                    lat: 24.966722,
                    lng: 121.192594
                },
                amenities: ["冷氣", "冰箱", "Wi-Fi", "洗衣機", "熱水器", "電視", "沙發"],
                available: true,
                contact: {
                    name: "張先生",
                    phone: "0934-567-890"
                }
            }
        };

        // 全局變量來存儲當前位置和地圖實例
        let currentMap = null;
        let currentLocation = null;

        // 全域宣告 currentRentalId
        window.currentRentalId = null;

        // 頁面切換函數
        window.showPage = function(pageId) {
            // 儲存當前頁面 ID
            const previousPage = Array.from(document.querySelectorAll('#homePage, #mapPage, #detailPage'))
                .find(page => !page.classList.contains('hidden'))?.id;

            // 隱藏所有頁面
            document.querySelectorAll('#homePage, #mapPage, #detailPage').forEach(page => {
                page.classList.add('hidden');
            });
            
            // 顯示目標頁面
            document.getElementById(pageId).classList.remove('hidden');

            // 如果從詳情頁面返回地圖頁面，重新初始化地圖
            if (previousPage === 'detailPage' && pageId === 'mapPage' && currentLocation) {
                setTimeout(() => {
                    initializeMap('map', currentLocation.lat, currentLocation.lng, currentLocation.name);
                    
                    // 重新載入租屋資料
                    const rentalsRef = ref(database, 'rentals');
                    onValue(rentalsRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            updateRentalsList(data, currentLocation);
                        } else {
                            console.log('使用模擬資料');
                            updateRentalsList(mockRentals, currentLocation);
                        }
                    }, (error) => {
                        console.log('使用模擬資料');
                        updateRentalsList(mockRentals, currentLocation);
                    });
                }, 100);
            }
        };

        // 選擇地點
        window.selectLocation = function(locationKey) {
            const location = locations[locationKey];
            // 儲存當前位置
            currentLocation = location;
            
            showPage('mapPage');
            
            // 初始化地圖
            setTimeout(() => {
                initializeMap('map', location.lat, location.lng, location.name);
                
                // 載入租屋資料
                const rentalsRef = ref(database, 'rentals');
                onValue(rentalsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        updateRentalsList(data, location);
                    } else {
                        console.log('使用模擬資料');
                        updateRentalsList(mockRentals, location);
                    }
                }, (error) => {
                    console.log('使用模擬資料');
                    updateRentalsList(mockRentals, location);
                });
            }, 100);
        };

        // 初始化地圖的函數
        function initializeMap(containerId, lat, lng, title) {
            // 如果已經有地圖實例，先移除它
            if (currentMap) {
                currentMap.remove();
                currentMap = null;
            }

            const container = document.getElementById(containerId);
            if (!container) {
                console.error('找不到地圖容器:', containerId);
                return;
            }

            // 創建新的地圖實例
            currentMap = L.map(containerId).setView([lat, lng], 17);
            
            // 添加 OpenStreetMap 圖層
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(currentMap);

            // 添加標記
            L.marker([lat, lng])
                .addTo(currentMap)
                .bindPopup(title)
                .openPopup();

            // 強制重新計算地圖大小
            setTimeout(() => {
                currentMap.invalidateSize();
            }, 100);
        }

        // 更新租屋列表
        function updateRentalsList(rentals, currentLocation) {
            const rentalsList = document.getElementById('rentalsList');
            rentalsList.innerHTML = '';

            // 獲取篩選條件
            const priceFilter = document.getElementById('priceFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            const hasElevator = document.getElementById('hasElevatorFilter').checked;
            const hasSeparateBathroom = document.getElementById('hasSeparateBathroomFilter').checked;
            const canShortTerm = document.getElementById('canShortTermFilter').checked;
            const hasParking = document.getElementById('hasParkingFilter').checked;

            // 篩選和排序租屋資料
            let filteredRentals = Object.entries(rentals)
                .filter(([id, rental]) => {
                    if (rental.areaId !== currentLocation.id) return false;
                    
                    // 價格篩選
                    if (priceFilter) {
                        if (priceFilter === '16000+') {
                            if (rental.price < 16000) return false;
                        } else {
                            const [min, max] = priceFilter.split('-').map(Number);
                            if (rental.price < min || rental.price > max) return false;
                        }
                    }

                    // 特色篩選
                    if (hasElevator && !rental.features?.hasElevator) return false;
                    if (hasSeparateBathroom && !rental.features?.hasSeparateBathroom) return false;
                    if (canShortTerm && !rental.features?.canShortTerm) return false;
                    if (hasParking && !rental.features?.hasParking) return false;

                    return true;
                })
                .sort(([idA, rentalA], [idB, rentalB]) => {
                    switch (sortFilter) {
                        case 'price-asc':
                            return rentalA.price - rentalB.price;
                        case 'price-desc':
                            return rentalB.price - rentalA.price;
                        case 'rating-desc':
                            return (rentalB.rating || 0) - (rentalA.rating || 0);
                        case 'favorites-desc':
                            return (rentalB.favorites || 0) - (rentalA.favorites || 0);
                        default:
                            return 0;
                    }
                });

            filteredRentals.forEach(([id, rental]) => {
                const rentalCard = document.createElement('div');
                rentalCard.className = 'bg-white rounded-lg shadow-md overflow-hidden';
                rentalCard.innerHTML = `
                    <div class="relative">
                        <img src="${rental.imageUrl}" alt="${rental.title}" class="w-full h-48 object-cover">
                        <button onclick="toggleFavorite('${id}')" 
                                class="absolute top-2 right-2 p-2 bg-white rounded-full shadow-md hover:bg-gray-100">
                            <i data-lucide="${isFavorite(id) ? 'heart' : 'heart'}" 
                               class="w-5 h-5 ${isFavorite(id) ? 'text-red-500' : 'text-gray-500'}"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-semibold mb-2">${rental.title}</h3>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xl font-bold text-blue-600">$${rental.price}/月</span>
                            <div class="flex items-center">
                                <i data-lucide="star" class="w-4 h-4 text-yellow-400 mr-1"></i>
                                <span>${rental.rating?.toFixed(1) || '0.0'}</span>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <p>${rental.type} · ${rental.size}坪 · ${rental.floor}</p>
                        </div>
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${rental.features?.hasElevator ? '<span class="px-2 py-1 bg-gray-100 rounded-full text-xs">電梯</span>' : ''}
                            ${rental.features?.hasSeparateBathroom ? '<span class="px-2 py-1 bg-gray-100 rounded-full text-xs">乾濕分離</span>' : ''}
                            ${rental.features?.canShortTerm ? '<span class="px-2 py-1 bg-gray-100 rounded-full text-xs">可短租</span>' : ''}
                            ${rental.features?.hasParking ? '<span class="px-2 py-1 bg-gray-100 rounded-full text-xs">停車位</span>' : ''}
                        </div>
                        <div class="flex justify-between items-center">
                        <button onclick="showRentalDetail('${id}')" 
                                    class="text-blue-600 hover:text-blue-700">
                            查看詳情
                        </button>
                            <button onclick="showReviewModal('${id}')"
                                    class="text-gray-600 hover:text-gray-700">
                                寫評論
                            </button>
                        </div>
                    </div>
                `;
                rentalsList.appendChild(rentalCard);
            });
            
            // 重新初始化圖標
            lucide.createIcons();
        }

        // 收藏功能
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

        function isFavorite(rentalId) {
            return favorites.includes(rentalId);
        }

        function toggleFavorite(rentalId) {
            const index = favorites.indexOf(rentalId);
            if (index === -1) {
                favorites.push(rentalId);
            } else {
                favorites.splice(index, 1);
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateRentalsList(mockRentals, currentLocation);
        }

        // 評論功能
        window.showReviewModal = function(rentalId) {
            console.log('Opening review modal for rental:', rentalId); // 添加调试日志
            window.currentRentalId = rentalId;
            const modal = document.getElementById('reviewModal');
            if (modal) {
                modal.classList.remove('hidden');
                lucide.createIcons();
            } else {
                console.error('Review modal element not found!');
            }
        }

        window.closeReviewModal = function() {
            console.log('Closing review modal');
            const modal = document.getElementById('reviewModal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('reviewForm').reset();
                window.currentRentalId = null;
            } else {
                console.error('Review modal element not found!');
            }
        }

        // 确保在页面加载完成后初始化评论表单
        document.addEventListener('DOMContentLoaded', function() {
            const reviewForm = document.getElementById('reviewForm');
            if (reviewForm) {
                reviewForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const rating = parseFloat(document.getElementById('reviewRating').value);
                    const text = document.getElementById('reviewText').value;
                    
                    if (!window.currentRentalId) {
                        console.error('No rental ID selected!');
                        return;
                    }
                    
                    // 添加新評論
                    const newReview = {
                        author: "訪客", // 這裡可以根據實際登入狀態修改
                        rating: rating,
                        text: text,
                        date: new Date().toISOString().split('T')[0]
                    };

                    if (mockRentals[window.currentRentalId]) {
                        if (!mockRentals[window.currentRentalId].reviews) {
                            mockRentals[window.currentRentalId].reviews = [];
                        }
                        mockRentals[window.currentRentalId].reviews.push(newReview);
                        
                        // 更新平均評分
                        const reviews = mockRentals[window.currentRentalId].reviews;
                        mockRentals[window.currentRentalId].rating = reviews.reduce((sum, review) => sum + review.rating, 0) / reviews.length;
                        
                        // 关闭弹窗并更新列表
                        closeReviewModal();
                        updateRentalsList(mockRentals, currentLocation);
                    } else {
                        console.error('Rental not found:', window.currentRentalId);
                    }
                });
            } else {
                console.error('Review form element not found!');
            }
        });

        // 添加篩選器事件監聽
        document.getElementById('priceFilter').addEventListener('change', () => updateRentalsList(mockRentals, currentLocation));
        document.getElementById('sortFilter').addEventListener('change', () => updateRentalsList(mockRentals, currentLocation));
        document.getElementById('hasElevatorFilter').addEventListener('change', () => updateRentalsList(mockRentals, currentLocation));
        document.getElementById('hasSeparateBathroomFilter').addEventListener('change', () => updateRentalsList(mockRentals, currentLocation));
        document.getElementById('canShortTermFilter').addEventListener('change', () => updateRentalsList(mockRentals, currentLocation));
        document.getElementById('hasParkingFilter').addEventListener('change', () => updateRentalsList(mockRentals, currentLocation));

        // 更新顯示租屋詳情的函數
        window.showRentalDetail = function(rentalId) {
            window.currentRentalId = rentalId;
            showPage('detailPage');
            
            const rental = mockRentals[rentalId];
            if (!rental) return;

                // 更新基本資訊
                const rentalInfo = document.getElementById('rentalInfo');
                rentalInfo.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">${rental.title}</h2>
                <div class="flex items-center justify-between mb-4">
                    <span class="text-2xl font-bold text-blue-600">$${rental.price}/月</span>
                    <div class="flex items-center">
                        <i data-lucide="star" class="w-5 h-5 text-yellow-400 mr-1"></i>
                        <span class="text-lg">${rental.rating?.toFixed(1) || '0.0'}</span>
                    </div>
                </div>
                <div class="space-y-4">
                        <div>
                        <h3 class="text-lg font-semibold mb-2">房屋資訊</h3>
                        <p class="text-gray-600">${rental.type} · ${rental.size}坪 · ${rental.floor}</p>
                        </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">房屋特色</h3>
                        <div class="flex flex-wrap gap-2">
                            ${rental.features?.hasElevator ? '<span class="px-3 py-1 bg-gray-100 rounded-full">電梯</span>' : ''}
                            ${rental.features?.hasSeparateBathroom ? '<span class="px-3 py-1 bg-gray-100 rounded-full">乾濕分離</span>' : ''}
                            ${rental.features?.canShortTerm ? '<span class="px-3 py-1 bg-gray-100 rounded-full">可短租</span>' : ''}
                            ${rental.features?.hasParking ? '<span class="px-3 py-1 bg-gray-100 rounded-full">停車位</span>' : ''}
                    </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">設備清單</h3>
                        <div class="flex flex-wrap gap-2">
                        ${rental.amenities.map(amenity => 
                                `<span class="px-3 py-1 bg-gray-100 rounded-full">${amenity}</span>`
                        ).join('')}
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">房屋描述</h3>
                        <p class="text-gray-600">${rental.description}</p>
                    </div>
                    <div class="contact-info mt-6">
                        <h3 class="text-lg font-semibold mb-2">聯絡資訊</h3>
                        <p>聯絡人：${rental.contact.name}</p>
                        <p>電話：${rental.contact.phone}</p>
                    </div>
                    </div>
                `;

                // 更新圖片
                const rentalImage = document.getElementById('rentalImage');
                rentalImage.src = rental.imageUrl;
                rentalImage.onerror = function() { this.src = defaultImage; };

                // 初始化詳情頁面的地圖
                initializeMap('detailMap', rental.location.lat, rental.location.lng, rental.title);

                // 更新位置資訊
                const locationInfo = document.getElementById('locationInfo');
                locationInfo.innerHTML = `
                    <h3 class="text-lg font-semibold mb-2">位置資訊</h3>
                    <div class="mt-4">
                        <p class="text-sm text-gray-500">經緯度座標：</p>
                        <p class="text-sm text-gray-600">緯度：${rental.location.lat}</p>
                        <p class="text-sm text-gray-600">經度：${rental.location.lng}</p>
                    </div>
                `;

            // 更新評論列表
            const reviewsList = document.getElementById('reviewsList');
            if (rental.reviews && rental.reviews.length > 0) {
                reviewsList.innerHTML = rental.reviews.map(review => `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-semibold">${review.author}</span>
                                <span class="text-sm text-gray-500 ml-2">${review.date}</span>
                            </div>
                            <div class="flex items-center">
                                <i data-lucide="star" class="w-4 h-4 text-yellow-400 mr-1"></i>
                                <span>${review.rating}</span>
                            </div>
                        </div>
                        <p class="text-gray-600">${review.text}</p>
                    </div>
                `).join('');
            } else {
                reviewsList.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500">目前還沒有評論</p>
                    </div>
                `;
            }

            // 重新初始化圖標
            lucide.createIcons();
        };
    </script>
</body>
</html>