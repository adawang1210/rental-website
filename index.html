<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中央大學租屋地圖</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        .glow-effect {
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
        }
        
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
        }
        
        .animated-bg {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
        }
        
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .pulse-ring {
            animation: pulse-ring 2s infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.95); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        
        .typing-animation::after {
            content: '|';
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .rental-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .rental-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .rental-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .rental-info {
            padding: 20px;
        }
        .rental-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .rental-type {
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            margin-right: 8px;
        }
        .rental-status {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .status-available {
            background: #2ecc71;
            color: white;
        }
        .status-unavailable {
            background: #e74c3c;
            color: white;
        }
        .rental-size-floor {
            color: #666;
            font-size: 0.95em;
            margin: 8px 0;
        }
        .price {
            color: #e74c3c;
            font-size: 1.4em;
            font-weight: bold;
            margin: 10px 0;
        }
        .distance {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .description {
            color: #444;
            font-size: 0.95em;
            line-height: 1.5;
            margin: 12px 0;
        }
        .amenities-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        .amenity-tag {
            background: #f8f9fa;
            color: #666;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .contact-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .contact-info p {
            margin: 5px 0;
            color: #444;
        }
        .view-details {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            margin-top: 10px;
            transition: background 0.2s;
        }
        .view-details:hover {
            background: #2980b9;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
        }
    </style>
</head>
<body class="min-h-screen animated-bg">
    <!-- 首頁 -->
    <div id="homePage" class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
        <!-- 背景裝飾 -->
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute -top-40 -right-40 w-80 h-80 bg-white opacity-10 rounded-full floating-animation"></div>
            <div class="absolute -bottom-40 -left-40 w-96 h-96 bg-white opacity-5 rounded-full" style="animation-delay: -3s;"></div>
            <div class="absolute top-1/2 left-1/4 w-2 h-2 bg-white opacity-60 rounded-full pulse-ring"></div>
            <div class="absolute bottom-1/4 right-1/3 w-1 h-1 bg-white opacity-40 rounded-full pulse-ring" style="animation-delay: -1s;"></div>
        </div>

        <!-- 主要內容 -->
        <div class="relative z-10 text-center max-w-4xl mx-auto">
            <!-- 標題區域 -->
            <div class="mb-12" data-aos="fade-down" data-aos-duration="1000">
                <div class="inline-flex items-center gap-3 mb-6">
                    <div class="p-3 bg-white bg-opacity-20 rounded-xl backdrop-blur-sm">
                        <i data-lucide="map-pin" class="w-8 h-8 text-white"></i>
                    </div>
                    <h1 class="text-5xl md:text-7xl font-bold text-white mb-4">
                        中央大學
                        <span class="block gradient-text bg-white bg-clip-text">租屋地圖</span>
                    </h1>
                </div>
                <p class="text-xl md:text-2xl text-white opacity-90 mb-4 typing-animation">
                    探索校園周邊最佳住宿選擇
                </p>
                <p class="text-lg text-white opacity-75 max-w-2xl mx-auto">
                    結合地圖導航、真實評價與智能篩選，為中大學生打造最貼心的租屋體驗
                </p>
        </div>

            

            <!-- 地點選擇按鈕 -->
            <div class="space-y-4" data-aos="zoom-in" data-aos-duration="1000" data-aos-delay="400">
                <h2 class="text-2xl font-semibold text-white mb-8">選擇探索區域</h2>
                <div class="grid md:grid-cols-3 gap-4 max-w-4xl mx-auto">
                    <button onclick="selectLocation('ncu')" class="group relative overflow-hidden bg-white bg-opacity-10 backdrop-blur-sm border border-white border-opacity-20 rounded-2xl p-8 card-hover text-left">
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-600 opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                        <div class="relative z-10">
                            <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mb-4 glow-effect">
                                <i data-lucide="graduation-cap" class="w-6 h-6 text-white"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-white mb-2">中央大學後門</h3>
                            <p class="text-white opacity-80 text-sm mb-4">步行3分鐘到校，生活機能完善</p>
                            <div class="flex items-center text-white opacity-60">
                                <i data-lucide="clock" class="w-4 h-4 mr-2"></i>
                                <span class="text-sm">3分鐘步行</span>
                </div>
                    </div>
                    </button>
                    
                    <button onclick="selectLocation('nightMarket')" class="group relative overflow-hidden bg-white bg-opacity-10 backdrop-blur-sm border border-white border-opacity-20 rounded-2xl p-8 card-hover text-left">
                        <div class="absolute inset-0 bg-gradient-to-r from-orange-500 to-red-600 opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                        <div class="relative z-10">
                            <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center mb-4 glow-effect">
                                <i data-lucide="utensils" class="w-6 h-6 text-white"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-white mb-2">宵夜街</h3>
                            <p class="text-white opacity-80 text-sm mb-4">美食天堂，夜生活豐富</p>
                            <div class="flex items-center text-white opacity-60">
                                <i data-lucide="moon" class="w-4 h-4 mr-2"></i>
                                <span class="text-sm">夜市聚集地</span>
                            </div>
                        </div>
                    </button>
                    
                    <button onclick="selectLocation('luxuryAlley')" class="group relative overflow-hidden bg-white bg-opacity-10 backdrop-blur-sm border border-white border-opacity-20 rounded-2xl p-8 card-hover text-left">
                        <div class="absolute inset-0 bg-gradient-to-r from-purple-500 to-pink-600 opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                        <div class="relative z-10">
                            <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mb-4 glow-effect">
                                <i data-lucide="crown" class="w-6 h-6 text-white"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-white mb-2">奢侈巷</h3>
                            <p class="text-white opacity-80 text-sm mb-4">高品質住宿，環境優雅</p>
                            <div class="flex items-center text-white opacity-60">
                                <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                                <span class="text-sm">精品住宿</span>
                            </div>
                        </div>
                    </button>
                            </div>
                        </div>

            <!-- 統計資訊 -->
            <div class="mt-16 grid grid-cols-3 gap-8 max-w-md mx-auto" data-aos="fade-up" data-aos-duration="1000" data-aos-delay="600">
                <div class="text-center">
                    <div class="text-3xl font-bold text-white mb-2">500+</div>
                    <div class="text-white opacity-70 text-sm">房源數量</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-white mb-2">1000+</div>
                    <div class="text-white opacity-70 text-sm">學生評價</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-white mb-2">4.8</div>
                    <div class="text-white opacity-70 text-sm">滿意度</div>
                </div>
            </div>
        </div>
                                </div>

    <!-- 地圖頁面 -->
    <div id="mapPage" class="hidden min-h-screen bg-gray-50">
        <!-- 頂部導航 -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="showPage('homePage')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    返回首頁
                </button>
                <h1 class="text-xl font-semibold text-gray-900">租屋地圖</h1>
                <div class="w-20"></div>
                                </div>
                            </div>

        <!-- 地圖容器 -->
        <div class="flex h-[calc(100vh-64px)]">
            <!-- 地圖區域 -->
            <div class="flex-1 relative">
                <div id="map" class="w-full h-full"></div>
                            </div>
            
            <!-- 租屋列表 -->
            <div class="w-96 bg-white shadow-lg overflow-y-auto">
                <div class="p-6 border-b">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">附近租屋</h2>
                    <!-- 篩選器 -->
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-700 mb-1 block">價格範圍</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">全部價格</option>
                                <option value="0-8000">8,000以下</option>
                                <option value="8000-12000">8,000-12,000</option>
                                <option value="12000-16000">12,000-16,000</option>
                                <option value="16000+">16,000以上</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="rentalsList" class="p-4 space-y-4">
                    <!-- 租屋卡片將在這裡動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 詳情頁面 -->
    <div id="detailPage" class="hidden min-h-screen bg-gray-50">
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="showPage('mapPage')" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    返回地圖
                </button>
                <h1 class="text-xl font-semibold text-gray-900">租屋詳情</h1>
                <div class="w-20"></div>
            </div>
        </div>
        
        <div class="max-w-4xl mx-auto p-6">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <img id="rentalImage" class="w-full h-80 object-cover" src="" alt="租屋照片">
                        <div id="rentalInfo" class="p-6"></div>
                    </div>
                    <div>
                        <div id="detailMap" class="w-full h-80"></div>
                        <div id="locationInfo" class="p-6"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

        // 初始化圖標
        lucide.createIcons();
        
        // 初始化AOS動畫
        AOS.init({
            duration: 800,
            once: true
        });

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyCzdE6ZxVrifrzAOP7OV1LsIcJj1QeehGY",
            authDomain: "rental-website-4da8f.firebaseapp.com",
            projectId: "rental-website-4da8f",
            storageBucket: "rental-website-4da8f.firebasestorage.app",
            messagingSenderId: "922669059596",
            appId: "1:922669059596:web:adeac316ceff6d78602829",
            measurementId: "G-Z7L3NFW4YZ",
            databaseURL: "https://rental-website-4da8f-default-rtdb.firebaseio.com"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // 定義地點座標和ID
        const locations = {
            ncu: { 
                id: 0,
                lat: 24.965484, 
                lng: 121.191116, 
                name: '中央大學後門'
            },
            nightMarket: { 
                id: 1,
                lat: 24.965871, 
                lng: 121.193606, 
                name: '宵夜街'
            },
            luxuryAlley: { 
                id: 2,
                lat: 24.966822, 
                lng: 121.192694, 
                name: '奢侈巷'
            }
        };

        // 模擬租屋資料
        const mockRentals = {
            rental1: {
                title: "溫馨套房 - 近中大後門",
                price: 8000,
                type: "套房",
                size: 7.5,
                floor: "2F / 5F",
                areaId: 0, // 後門
                description: "位於中央大學後門附近，走路5分鐘即可到校。房間採光良好，附基本家具（書桌、椅子、床架）。獨立衛浴，適合學生居住。",
                imageUrl: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=400&h=300&fit=crop",
                location: {
                    lat: 24.965684,
                    lng: 121.191316
                },
                amenities: ["冷氣", "冰箱", "Wi-Fi", "洗衣機", "熱水器"],
                available: true,
                contact: {
                    name: "林小姐",
                    phone: "0912-345-678"
                }
            },
            rental2: {
                title: "現代化套房 - 宵夜街",
                price: 9000,
                type: "套房",
                size: 8.0,
                floor: "3F / 5F",
                areaId: 1, // 宵夜街
                description: "位於熱鬧的宵夜街，生活機能極佳。房間全新裝潢，配備齊全。",
                imageUrl: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=400&h=300&fit=crop",
                location: {
                    lat: 24.965971,
                    lng: 121.193506
                },
                amenities: ["冷氣", "冰箱", "Wi-Fi", "洗衣機", "熱水器", "電視"],
                available: true,
                contact: {
                    name: "王先生",
                    phone: "0923-456-789"
                }
            },
            rental3: {
                title: "豪華套房 - 奢侈巷",
                price: 12000,
                type: "套房",
                size: 12.0,
                floor: "4F / 5F",
                areaId: 2, // 奢侈巷
                description: "位於高級住宅區，環境清幽。房間寬敞明亮，配備高級家具及家電。",
                imageUrl: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=400&h=300&fit=crop",
                location: {
                    lat: 24.966722,
                    lng: 121.192594
                },
                amenities: ["冷氣", "冰箱", "Wi-Fi", "洗衣機", "熱水器", "電視", "沙發"],
                available: true,
                contact: {
                    name: "張先生",
                    phone: "0934-567-890"
                }
            }
        };

        // 全局變量來存儲當前位置和地圖實例
        let currentMap = null;
        let currentLocation = null;

        // 頁面切換函數
        window.showPage = function(pageId) {
            // 儲存當前頁面 ID
            const previousPage = Array.from(document.querySelectorAll('#homePage, #mapPage, #detailPage'))
                .find(page => !page.classList.contains('hidden'))?.id;

            // 隱藏所有頁面
            document.querySelectorAll('#homePage, #mapPage, #detailPage').forEach(page => {
                page.classList.add('hidden');
            });
            
            // 顯示目標頁面
            document.getElementById(pageId).classList.remove('hidden');

            // 如果從詳情頁面返回地圖頁面，重新初始化地圖
            if (previousPage === 'detailPage' && pageId === 'mapPage' && currentLocation) {
                setTimeout(() => {
                    initializeMap('map', currentLocation.lat, currentLocation.lng, currentLocation.name);
                    
                    // 重新載入租屋資料
                    const rentalsRef = ref(database, 'rentals');
                    onValue(rentalsRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            updateRentalsList(data, currentLocation);
                        } else {
                            console.log('使用模擬資料');
                            updateRentalsList(mockRentals, currentLocation);
                        }
                    }, (error) => {
                        console.log('使用模擬資料');
                        updateRentalsList(mockRentals, currentLocation);
                    });
                }, 100);
            }
        };

        // 選擇地點
        window.selectLocation = function(locationKey) {
            const location = locations[locationKey];
            // 儲存當前位置
            currentLocation = location;
            
            showPage('mapPage');
            
            // 初始化地圖
            setTimeout(() => {
                initializeMap('map', location.lat, location.lng, location.name);
                
                // 載入租屋資料
                const rentalsRef = ref(database, 'rentals');
                onValue(rentalsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        updateRentalsList(data, location);
                    } else {
                        console.log('使用模擬資料');
                        updateRentalsList(mockRentals, location);
                    }
                }, (error) => {
                    console.log('使用模擬資料');
                    updateRentalsList(mockRentals, location);
                });
            }, 100);
        };

        // 初始化地圖的函數
        function initializeMap(containerId, lat, lng, title) {
            // 如果已經有地圖實例，先移除它
            if (currentMap) {
                currentMap.remove();
                currentMap = null;
            }

            const container = document.getElementById(containerId);
            if (!container) {
                console.error('找不到地圖容器:', containerId);
                return;
            }

            // 創建新的地圖實例
            currentMap = L.map(containerId).setView([lat, lng], 17);
            
            // 添加 OpenStreetMap 圖層
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(currentMap);

            // 添加標記
            L.marker([lat, lng])
                .addTo(currentMap)
                .bindPopup(title)
                .openPopup();

            // 強制重新計算地圖大小
            setTimeout(() => {
                currentMap.invalidateSize();
            }, 100);
        }

        // 更新租屋列表
        function updateRentalsList(rentals, currentLocation) {
            const rentalsList = document.getElementById('rentalsList');
            rentalsList.innerHTML = '';

            // 預設圖片（灰色背景加上房子圖標）
            const defaultImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHBhdGggZD0iTTE1MCA4MEw5MCAxNDBoMTIwTDE1MCA4MHoiIGZpbGw9IiM5OTkiLz48cmVjdCB4PSIxMjAiIHk9IjE0MCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjOTk5Ii8+PHRleHQgeD0iMTUwIiB5PSI5MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNjY2Ij7nhKHlm77niYc8L3RleHQ+PC9zdmc+';

            Object.entries(rentals).forEach(([id, rental]) => {
                // 檢查是否屬於當前選擇的區域
                if (rental.areaId !== currentLocation.id) {
                    return;
                }

                if (!rental.location) return; // 跳過沒有位置資訊的租屋資料

                const distance = calculateDistance(
                    currentLocation.lat,
                    currentLocation.lng,
                    rental.location.lat,
                    rental.location.lng
                );

                const rentalCard = document.createElement('div');
                rentalCard.className = 'rental-card mb-4';
                rentalCard.innerHTML = `
                    <div class="rental-image-container">
                        <img src="${rental.imageUrl}" 
                             alt="${rental.title}" 
                             class="rental-image"
                             onerror="this.src='${defaultImage}'">
                    </div>
                    <div class="rental-info">
                        <div class="rental-header">
                            <div class="flex items-center gap-2">
                                <span class="rental-type">${rental.type}</span>
                                <span class="rental-status ${rental.available ? 'status-available' : 'status-unavailable'}">
                                    ${rental.available ? '可出租' : '已出租'}
                                </span>
                            </div>
                        </div>
                        <h3 class="text-xl font-semibold mt-2">${rental.title}</h3>
                        <div class="rental-size-floor mt-2 text-gray-600">
                            <span>${rental.size} 坪</span> | 
                            <span>${rental.floor}</span>
                        </div>
                        <div class="price mt-2 text-2xl font-bold text-red-600">NT$ ${rental.price.toLocaleString()}/月</div>
                        <div class="distance mt-2 text-gray-600">距離約 ${distance.toFixed(1)} 公里</div>
                        <div class="description mt-2 text-gray-700">${rental.description}</div>
                        <div class="amenities-list mt-4">
                            ${rental.amenities.map(amenity => 
                                `<span class="amenity-tag">${amenity}</span>`
                            ).join('')}
                        </div>
                        <div class="contact-info mt-4 bg-gray-50 p-4 rounded-lg">
                            <p class="text-gray-700">聯絡人：${rental.contact.name}</p>
                            <p class="text-gray-700">電話：${rental.contact.phone}</p>
                        </div>
                        <button onclick="showRentalDetail('${id}')" 
                                class="view-details mt-4 w-full text-center bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                            查看詳情
                        </button>
                    </div>
                `;
                rentalsList.appendChild(rentalCard);
            });
            
            // 如果沒有找到任何租屋資料
            if (rentalsList.children.length === 0) {
                rentalsList.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500 text-lg">此區域目前沒有可用的租屋資訊</p>
                    </div>
                `;
            }
            
            // 重新初始化圖標
            lucide.createIcons();
        }

        // 計算兩點之間的距離（使用 Haversine 公式）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球半徑（公里）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // 更新顯示租屋詳情的函數
        window.showRentalDetail = function(rentalId) {
            showPage('detailPage');
            
            // 從 Firebase 獲取數據
            const rentalsRef = ref(database, 'rentals/' + rentalId);
            onValue(rentalsRef, (snapshot) => {
                const rental = snapshot.val();
                if (!rental) {
                    console.error('找不到租屋資料');
                    return;
                }

                // 更新基本資訊
                const rentalInfo = document.getElementById('rentalInfo');
                rentalInfo.innerHTML = `
                    <div class="rental-header">
                        <div>
                            <span class="rental-type">${rental.type}</span>
                            <span class="rental-status ${rental.available ? 'status-available' : 'status-unavailable'}">
                                ${rental.available ? '可出租' : '已出租'}
                            </span>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold mt-4">${rental.title}</h2>
                    <div class="rental-size-floor mt-2">
                        <span>${rental.size} 坪</span> | 
                        <span>${rental.floor}</span>
                    </div>
                    <div class="price mt-4">NT$ ${rental.price.toLocaleString()}/月</div>
                    <div class="description mt-4">${rental.description}</div>
                    <div class="amenities-list mt-4">
                        ${rental.amenities.map(amenity => 
                            `<span class="amenity-tag">${amenity}</span>`
                        ).join('')}
                    </div>
                    <div class="contact-info mt-6">
                        <h3 class="text-lg font-semibold mb-2">聯絡資訊</h3>
                        <p>聯絡人：${rental.contact.name}</p>
                        <p>電話：${rental.contact.phone}</p>
                    </div>
                `;

                // 更新圖片
                const rentalImage = document.getElementById('rentalImage');
                rentalImage.src = rental.imageUrl;
                rentalImage.onerror = function() { this.src = defaultImage; };

                // 初始化詳情頁面的地圖
                initializeMap('detailMap', rental.location.lat, rental.location.lng, rental.title);

                // 更新位置資訊
                const locationInfo = document.getElementById('locationInfo');
                locationInfo.innerHTML = `
                    <h3 class="text-lg font-semibold mb-2">位置資訊</h3>
                    <div class="mt-4">
                        <p class="text-sm text-gray-500">經緯度座標：</p>
                        <p class="text-sm text-gray-600">緯度：${rental.location.lat}</p>
                        <p class="text-sm text-gray-600">經度：${rental.location.lng}</p>
                    </div>
                `;
            }, (error) => {
                console.error('讀取租屋資料時發生錯誤：', error);
            });
        };
    </script>
</body>
</html>